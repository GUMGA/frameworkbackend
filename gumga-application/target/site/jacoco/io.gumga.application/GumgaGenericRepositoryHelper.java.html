<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GumgaGenericRepositoryHelper.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gumga-application</a> &gt; <a href="index.source.html" class="el_package">io.gumga.application</a> &gt; <span class="el_source">GumgaGenericRepositoryHelper.java</span></div><h1>GumgaGenericRepositoryHelper.java</h1><pre class="source lang-java linenums">package io.gumga.application;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.gumga.core.QueryObjectElement;
import io.gumga.core.utils.ReflectionUtils;
import io.gumga.domain.AbstractStringCriterionParser;
import io.gumga.domain.GumgaQueryParserProvider;
import io.gumga.domain.domains.GumgaMoney;
import org.springframework.data.jpa.repository.support.JpaEntityInformation;

import java.io.IOException;
import java.lang.reflect.Field;
import java.text.Normalizer;
import java.util.*;

public class GumgaGenericRepositoryHelper {

    private static Map&lt;GumgaHqlEntry, GumgaHqlElement&gt; hqlConverter;

<span class="nc" id="L21">    private GumgaGenericRepositoryHelper() {</span>
<span class="nc" id="L22">    }</span>

    /**
     * Faz substituição dos operadores especificados no atributo hqlConverter para operadores do tipo SQL
     * @return
     */
    public static Map&lt;GumgaHqlEntry, GumgaHqlElement&gt; getHqlConverter() {
<span class="nc bnc" id="L29" title="All 2 branches missed.">        if (hqlConverter == null) {</span>
<span class="nc" id="L30">            hqlConverter = new HashMap&lt;&gt;();</span>

<span class="nc" id="L32">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.DEFAULT, &quot;eq&quot;), new GumgaHqlElement(&quot;='&quot;, &quot;'&quot;));</span>
<span class="nc" id="L33">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.DEFAULT, &quot;ne&quot;), new GumgaHqlElement(&quot;!='&quot;, &quot;'&quot;));</span>
<span class="nc" id="L34">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.DEFAULT, &quot;ge&quot;), new GumgaHqlElement(&quot;&gt;='&quot;, &quot;'&quot;));</span>
<span class="nc" id="L35">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.DEFAULT, &quot;le&quot;), new GumgaHqlElement(&quot;&lt;='&quot;, &quot;'&quot;));</span>
<span class="nc" id="L36">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.DEFAULT, &quot;gt&quot;), new GumgaHqlElement(&quot;&gt;'&quot;, &quot;'&quot;));</span>
<span class="nc" id="L37">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.DEFAULT, &quot;lt&quot;), new GumgaHqlElement(&quot;&lt;'&quot;, &quot;'&quot;));</span>
<span class="nc" id="L38">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.DEFAULT, &quot;contains&quot;), new GumgaHqlElement(&quot; like '%&quot;, &quot;%'&quot;));</span>
<span class="nc" id="L39">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.DEFAULT, &quot;not_contains&quot;), new GumgaHqlElement(&quot; not like '%&quot;, &quot;%'&quot;));</span>
<span class="nc" id="L40">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.DEFAULT, &quot;starts_with&quot;), new GumgaHqlElement(&quot; like '&quot;, &quot;%'&quot;));</span>
<span class="nc" id="L41">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.DEFAULT, &quot;ends_with&quot;), new GumgaHqlElement(&quot; like '%&quot;, &quot;'&quot;));</span>

<span class="nc" id="L43">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.TEXT, &quot;contains&quot;), new GumgaHqlElement(&quot; like '%&quot;, &quot;%'&quot;));</span>
<span class="nc" id="L44">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.TEXT, &quot;not_contains&quot;), new GumgaHqlElement(&quot; not like '%&quot;, &quot;%'&quot;));</span>
<span class="nc" id="L45">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.TEXT, &quot;starts_with&quot;), new GumgaHqlElement(&quot; like '&quot;, &quot;%'&quot;));</span>
<span class="nc" id="L46">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.TEXT, &quot;ends_with&quot;), new GumgaHqlElement(&quot; like '%&quot;, &quot;'&quot;));</span>

<span class="nc" id="L48">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.NUMBER, &quot;eq&quot;), new GumgaHqlElement(&quot;=&quot;, &quot;&quot;));</span>
<span class="nc" id="L49">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.NUMBER, &quot;ne&quot;), new GumgaHqlElement(&quot;!=&quot;, &quot;&quot;));</span>
<span class="nc" id="L50">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.NUMBER, &quot;ge&quot;), new GumgaHqlElement(&quot;&gt;=&quot;, &quot;&quot;));</span>
<span class="nc" id="L51">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.NUMBER, &quot;le&quot;), new GumgaHqlElement(&quot;&lt;=&quot;, &quot;&quot;));</span>
<span class="nc" id="L52">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.NUMBER, &quot;gt&quot;), new GumgaHqlElement(&quot;&gt;&quot;, &quot;&quot;));</span>
<span class="nc" id="L53">            hqlConverter.put(new GumgaHqlEntry(GumgaFieldStereotype.NUMBER, &quot;lt&quot;), new GumgaHqlElement(&quot;&lt;&quot;, &quot;&quot;));</span>

        }
<span class="nc" id="L56">        return hqlConverter;</span>
    }

    public static GumgaFieldStereotype getFieldStereotype(Class type) {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (java.lang.String.class.equals(type)) {</span>
<span class="nc" id="L61">            return GumgaFieldStereotype.TEXT;</span>
        }
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (java.lang.Byte.class.equals(type)) {</span>
<span class="nc" id="L64">            return GumgaFieldStereotype.NUMBER;</span>
        }
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (java.lang.Double.class.equals(type)) {</span>
<span class="nc" id="L67">            return GumgaFieldStereotype.NUMBER;</span>
        }
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (java.lang.Float.class.equals(type)) {</span>
<span class="nc" id="L70">            return GumgaFieldStereotype.NUMBER;</span>
        }
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (java.lang.Integer.class.equals(type)) {</span>
<span class="nc" id="L73">            return GumgaFieldStereotype.NUMBER;</span>
        }
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (java.lang.Long.class.equals(type)) {</span>
<span class="nc" id="L76">            return GumgaFieldStereotype.NUMBER;</span>
        }
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (java.lang.Number.class.equals(type)) {</span>
<span class="nc" id="L79">            return GumgaFieldStereotype.NUMBER;</span>
        }
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (java.lang.Short.class.equals(type)) {</span>
<span class="nc" id="L82">            return GumgaFieldStereotype.NUMBER;</span>
        }
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (GumgaMoney.class.equals(type)) {</span>
<span class="nc" id="L85">            return GumgaFieldStereotype.NUMBER;</span>
        }

<span class="nc" id="L88">        return GumgaFieldStereotype.DEFAULT;</span>
    }

    /**
     * Gera um Objeto QueryObject através de uma String.
     * @param s
     * @return
     */
    public static List&lt;QueryObjectElement&gt; qoeFromString(String s) {
<span class="nc" id="L97">        List&lt;QueryObjectElement&gt; aRetornar = new ArrayList&lt;&gt;();</span>
        try {
<span class="nc" id="L99">            ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L100">            JsonNode mainNode = mapper.readTree(s);</span>
<span class="nc" id="L101">            Iterator&lt;JsonNode&gt; elements = mainNode.elements();</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            while (elements.hasNext()) {</span>
<span class="nc" id="L103">                QueryObjectElement qoe = new QueryObjectElement();</span>
<span class="nc" id="L104">                aRetornar.add(qoe);</span>
<span class="nc" id="L105">                JsonNode node = elements.next();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                if (node.has(&quot;attribute&quot;)) {</span>
<span class="nc" id="L107">                    qoe.setAttribute(node.get(&quot;attribute&quot;).get(&quot;name&quot;).asText());</span>
                }
<span class="nc bnc" id="L109" title="All 2 branches missed.">                if (node.has(&quot;hql&quot;)) {</span>
<span class="nc" id="L110">                    qoe.setHql(node.get(&quot;hql&quot;).get(&quot;hql&quot;).asText());</span>
                }
<span class="nc" id="L112">                qoe.setValue(node.get(&quot;value&quot;).asText());</span>
<span class="nc" id="L113">            }</span>
<span class="nc" id="L114">        } catch (IOException ex) {</span>
<span class="nc" id="L115">            throw new GumgaGenericRepostoryHelperException(ex);</span>
<span class="nc" id="L116">        }</span>
<span class="nc" id="L117">        return aRetornar;</span>

    }

    /**
     * Gera um HQL através das informações da entidade e do QueryObject especificado por parâmetro.
     * @param entityInformation
     * @param qoes
     * @return
     */
    public static String hqlFromQoes(JpaEntityInformation entityInformation, List&lt;QueryObjectElement&gt; qoes) {
<span class="nc" id="L128">        String aRetornar = &quot;&quot;;</span>

<span class="nc bnc" id="L130" title="All 2 branches missed.">        for (QueryObjectElement qoe : qoes) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (&quot;NO_ATTRIBUTE&quot;.equals(qoe.getAttribute())) {</span>
<span class="nc" id="L132">                aRetornar += &quot; &quot; + qoe.getValue() + &quot; &quot;;</span>
            } else {
<span class="nc" id="L134">                Class type = String.class;</span>
<span class="nc" id="L135">                Field field = ReflectionUtils.findField(entityInformation.getJavaType(), qoe.getAttribute());</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                if (field != null) {</span>
<span class="nc" id="L137">                    type = field.getType();</span>

                }
<span class="nc" id="L140">                GumgaFieldStereotype fieldStereotype = getFieldStereotype(type);</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">                if (GumgaQueryParserProvider.defaultMap.equals(GumgaQueryParserProvider.getOracleLikeMap()) &amp;&amp; fieldStereotype == GumgaFieldStereotype.TEXT) {</span>
<span class="nc" id="L142">                    aRetornar += &quot;upper(translate(obj.&quot; + qoe.getAttribute()</span>
                            + &quot;,'&quot; + AbstractStringCriterionParser.SOURCE_CHARS + &quot;','&quot; + AbstractStringCriterionParser.TARGET_CHARS + &quot;'&quot;
                            + &quot;)&quot; + &quot;)&quot;;
                } else {
<span class="nc" id="L146">                    aRetornar += &quot;obj.&quot; + qoe.getAttribute();</span>
                }

<span class="nc" id="L149">                GumgaHqlEntry het = new GumgaHqlEntry(fieldStereotype, qoe.getHql());</span>
<span class="nc" id="L150">                GumgaHqlElement hel = getHqlConverter().get(het);</span>
<span class="nc" id="L151">                aRetornar += hel.before + removeAcentos(qoe.getValue()).toUpperCase() + hel.after;</span>
            }
<span class="nc" id="L153">        }</span>
<span class="nc" id="L154">        return aRetornar;</span>
    }

    /**
     * Remove acentos do parametro especificado
     * @param str valor
     * @return parametro sem acentos
     */
    public static String removeAcentos(String str) {
<span class="nc" id="L163">        str = Normalizer.normalize(str, Normalizer.Form.NFD);</span>
<span class="nc" id="L164">        str = str.replaceAll(&quot;[^\\p{ASCII}]&quot;, &quot;&quot;);</span>
<span class="nc" id="L165">        return str;</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>