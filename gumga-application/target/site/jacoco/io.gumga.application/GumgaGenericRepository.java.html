<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GumgaGenericRepository.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gumga-application</a> &gt; <a href="index.source.html" class="el_package">io.gumga.application</a> &gt; <span class="el_source">GumgaGenericRepository.java</span></div><h1>GumgaGenericRepository.java</h1><pre class="source lang-java linenums">package io.gumga.application;

import com.google.common.base.Strings;
import io.gumga.core.GumgaThreadScope;
import io.gumga.core.QueryObject;
import io.gumga.core.SearchResult;
import io.gumga.core.TenancyPublicMarking;
import io.gumga.domain.*;
import io.gumga.domain.repository.GumgaCrudRepository;
import io.gumga.domain.repository.GumgaMultitenancyUtil;
import io.gumga.domain.shared.GumgaSharedModel;
import org.hibernate.Session;
import org.hibernate.criterion.Criterion;
import org.hibernate.criterion.MatchMode;
import org.hibernate.criterion.Restrictions;
import org.hibernate.envers.AuditReader;
import org.hibernate.envers.AuditReaderFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.data.jpa.repository.support.CrudMethodMetadata;
import org.springframework.data.jpa.repository.support.JpaEntityInformation;
import org.springframework.data.jpa.repository.support.SimpleJpaRepository;
import org.springframework.data.repository.NoRepositoryBean;

import javax.persistence.EntityManager;
import javax.persistence.EntityNotFoundException;
import javax.persistence.Query;
import javax.persistence.TypedQuery;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;

import static org.hibernate.criterion.Order.asc;
import static org.hibernate.criterion.Order.desc;
import static org.hibernate.criterion.Projections.rowCount;
import static org.hibernate.criterion.Restrictions.like;
import static org.hibernate.criterion.Restrictions.or;

@NoRepositoryBean
public class GumgaGenericRepository&lt;T, ID extends Serializable&gt; extends SimpleJpaRepository&lt;T, ID&gt; implements GumgaCrudRepository&lt;T, ID&gt; {

    protected final JpaEntityInformation&lt;T, ID&gt; entityInformation;
    protected final EntityManager entityManager;
<span class="fc" id="L50">    private static final Logger log = LoggerFactory.getLogger(GumgaGenericRepository.class);</span>

    public GumgaGenericRepository(JpaEntityInformation&lt;T, ID&gt; entityInformation, EntityManager entityManager) {
<span class="fc" id="L53">        super(entityInformation, entityManager);</span>
<span class="fc" id="L54">        this.entityManager = entityManager;</span>
<span class="fc" id="L55">        this.entityInformation = entityInformation;</span>
<span class="fc" id="L56">    }</span>

    @Override
    public SearchResult&lt;T&gt; search(QueryObject query) {
<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (query.isAdvanced()) {</span>
<span class="fc" id="L61">            return advancedSearch(query);</span>
        }

<span class="fc" id="L64">        Long count = count(query);</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">        List&lt;T&gt; data = query.isCountOnly() ? Collections.emptyList() : getOrdered(query);</span>

<span class="fc" id="L67">        return new SearchResult&lt;&gt;(query, count, data);</span>
    }

    private List&lt;T&gt; getOrdered(QueryObject query) {
<span class="fc" id="L71">        Pesquisa&lt;T&gt; pesquisa = getPesquisa(query);</span>
<span class="fc" id="L72">        String sortField = query.getSortField();</span>
<span class="fc" id="L73">        String sortType = query.getSortDir();</span>

<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (!sortField.isEmpty()) {</span>
<span class="fc" id="L76">            createAliasIfNecessary(pesquisa, sortField);</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">            pesquisa.addOrder(&quot;asc&quot;.equals(sortType) ? asc(sortField).ignoreCase() : desc(sortField).ignoreCase());</span>
        }
<span class="fc" id="L79">        pesquisa.addOrder(asc(&quot;id&quot;)); //GUMGA-478</span>

<span class="fc" id="L81">        return pesquisa.setFirstResult(query.getStart()).setMaxResults(query.getPageSize()).list();</span>
    }

    private Long count(QueryObject query) {
<span class="fc" id="L85">        Object uniqueResult = getPesquisa(query).setProjection(rowCount()).uniqueResult();</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">        return uniqueResult == null ? 0L : ((Number) uniqueResult).longValue();</span>
    }

    private Pesquisa&lt;T&gt; getPesquisa(QueryObject query) {
<span class="pc bpc" id="L90" title="1 of 4 branches missed.">        if (query.getSearchFields() != null &amp;&amp; query.getSearchFields().length == 0) {</span>
<span class="nc" id="L91">            throw new IllegalArgumentException(&quot;Para realizar a search deve se informar pelo menos um campo a ser pesquisado.&quot;);</span>
        }

<span class="fc" id="L94">        Criterion[] fieldsCriterions = new HibernateQueryObject(query).getCriterions(entityInformation.getJavaType());</span>
<span class="fc" id="L95">        Pesquisa&lt;T&gt; pesquisa = search().add(or(fieldsCriterions));</span>

<span class="pc bpc" id="L97" title="2 of 4 branches missed.">        if (hasMultitenancy() &amp;&amp; GumgaThreadScope.organizationCode.get() != null) {</span>
<span class="fc" id="L98">            String oiPattern = GumgaMultitenancyUtil.getMultitenancyPattern(entityInformation.getJavaType().getAnnotation(GumgaMultitenancy.class));</span>
            Criterion multitenancyCriterion;
            Criterion sharedCriterion;
<span class="fc" id="L101">            GumgaMultitenancy gumgaMultitenancy = getDomainClass().getAnnotation(GumgaMultitenancy.class);</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">            if (GumgaSharedModel.class.isAssignableFrom(entityInformation.getJavaType())) {</span>
<span class="fc" id="L103">                sharedCriterion = or(</span>
                      //  like(&quot;1&quot;,&quot;1&quot;,MatchMode.EXACT)
<span class="fc" id="L105">                        like(&quot;gumgaOrganizations&quot;, &quot;,&quot; + oiPattern + &quot;,&quot;, MatchMode.ANYWHERE),</span>
<span class="fc" id="L106">                        like(&quot;gumgaUsers&quot;, &quot;,&quot; + GumgaThreadScope.login.get() + &quot;,&quot;, MatchMode.ANYWHERE)</span>
                );

<span class="pc bpc" id="L109" title="1 of 2 branches missed.">                if (gumgaMultitenancy.allowPublics()) {</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">                    if (gumgaMultitenancy.publicMarking() == TenancyPublicMarking.NULL) {</span>
<span class="fc" id="L111">                        multitenancyCriterion = or(like(&quot;oi&quot;, oiPattern, MatchMode.START), Restrictions.isNull(&quot;oi&quot;), sharedCriterion);</span>
                    } else {
<span class="nc" id="L113">                        multitenancyCriterion = or(like(&quot;oi&quot;, oiPattern, MatchMode.START), Restrictions.eq(&quot;oi&quot;, gumgaMultitenancy.publicMarking().getMark()), sharedCriterion);</span>
                    }
                } else {
<span class="nc" id="L116">                    multitenancyCriterion = or(like(&quot;oi&quot;, oiPattern, MatchMode.START), sharedCriterion);</span>
                }
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">            } else if (gumgaMultitenancy.allowPublics()) {</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">                if (gumgaMultitenancy.publicMarking() == TenancyPublicMarking.NULL) {</span>
<span class="fc" id="L120">                    multitenancyCriterion = or(like(&quot;oi&quot;, oiPattern, MatchMode.START), Restrictions.isNull(&quot;oi&quot;));</span>
                } else {
<span class="nc" id="L122">                    multitenancyCriterion = or(like(&quot;oi&quot;, oiPattern, MatchMode.START), Restrictions.eq(&quot;oi&quot;, gumgaMultitenancy.publicMarking().getMark()));</span>
                }
            } else {
<span class="nc" id="L125">                multitenancyCriterion = or(like(&quot;oi&quot;, oiPattern, MatchMode.START));</span>
            }

<span class="fc" id="L128">            pesquisa.add(multitenancyCriterion);</span>
        }

<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (query.getSearchFields() != null) {</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">            for (String field : query.getSearchFields()) {</span>
<span class="fc" id="L133">                createAliasIfNecessary(pesquisa, field);</span>
            }
        }

<span class="fc" id="L137">        return pesquisa;</span>
    }

    /**
     * Verificar se a entidade utiliza o Multitenancy da Gumga
     * @return true se tiver e false caso não tiver anotada com @{@link GumgaMultitenancy}
     */
    public boolean hasMultitenancy() {
<span class="fc" id="L145">        return entityInformation.getJavaType().isAnnotationPresent(GumgaMultitenancy.class);</span>
    }

    public String getMultitenancyPattern() {
<span class="fc" id="L149">        GumgaMultitenancy tenacy = entityInformation.getJavaType().getAnnotation(GumgaMultitenancy.class);</span>
<span class="fc" id="L150">        return GumgaMultitenancyUtil.getMultitenancyPattern(tenacy);</span>
    }

    private void createAliasIfNecessary(Pesquisa&lt;T&gt; pesquisa, String field) {
<span class="fc" id="L154">        String[] chain = field.split(&quot;\\.&quot;);</span>

<span class="pc bpc" id="L156" title="1 of 2 branches missed.">        if (chain.length &lt;= 1) {</span>
<span class="fc" id="L157">            return;</span>
        }
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (pesquisa.getAliases().contains(chain[0])) {</span>
<span class="nc" id="L160">            return;</span>
        }

<span class="nc" id="L163">        pesquisa.createAlias(chain[0], chain[0]);</span>
<span class="nc" id="L164">        pesquisa.addAlias(chain[0]);</span>
<span class="nc" id="L165">    }</span>

    @Override
    public Pesquisa&lt;T&gt; search() {
<span class="fc" id="L169">        return Pesquisa.createCriteria(session(), entityInformation.getJavaType());</span>
    }

    /**
     * Pesquisa sql por id utilizando o Multitenancy se a entidade estiver anotada com @{@link GumgaMultitenancy}
     * @param id
     * @return entidade tipada na interface @{@link GumgaCrudRepository}
     */
    @Override
    public T findOne(ID id) {
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (GumgaSharedModel.class.isAssignableFrom(entityInformation.getJavaType())) {</span>
<span class="fc" id="L180">            QueryObject qo=new QueryObject();</span>
<span class="fc" id="L181">            qo.setAq(&quot;obj.id=&quot;+id);</span>
<span class="fc" id="L182">            SearchResult&lt;T&gt; search = this.search(qo);</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">            if (search.getCount()==1){</span>
<span class="fc" id="L184">                return search.getValues().get(0);</span>
            }
<span class="nc" id="L186">            throw new EntityNotFoundException(&quot;cannot find &quot; + entityInformation.getJavaType() + &quot; with id: &quot; + id);</span>
        }
        
<span class="nc" id="L189">        T resource = super.findOne(id);</span>

<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (resource == null) {</span>
<span class="nc" id="L192">            throw new EntityNotFoundException(&quot;cannot find &quot; + entityInformation.getJavaType() + &quot; with id: &quot; + id);</span>
        }
<span class="nc" id="L194">        checkOwnership(resource);</span>
<span class="nc" id="L195">        return resource;</span>
    }

    /**
     * Generic findOne
     *
     * @param clazz Classe a ser pesquisada
     * @param id id a ser pesquisado
     * @return objeto encontrado ou null
     */
    @Override
    public Object genericFindOne(Class clazz, Object id) {
<span class="nc" id="L207">        Object result = entityManager.find(clazz, id);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (result == null) {</span>
<span class="nc" id="L209">            throw new EntityNotFoundException(&quot;cannot find &quot; + clazz.getName() + &quot; with id: &quot; + id);</span>
        }
<span class="nc" id="L211">        checkOwnership(result);</span>
<span class="nc" id="L212">        return result;</span>
    }

    private Session session() {
<span class="fc" id="L216">        return entityManager.unwrap(Session.class);</span>
    }

    /**
     * Faz uma pesquisa no banco baseado na entidade que está tipada na interface {@link GumgaCrudRepository}
     * @param query
     * @return
     */
    private SearchResult&lt;T&gt; advancedSearch(QueryObject query) {
//        if (query.getAq().startsWith(&quot;{&quot;)) {
//            try {
//                ObjectMapper mapper = new ObjectMapper();
//                Map readValue = mapper.readValue(query.getAq(), Map.class);
//                query.setAq(readValue.get(&quot;hql&quot;).toString());
//            } catch (IOException ex) {
//                throw new RuntimeException(ex);
//            }
//        }

//        List&lt;QueryObjectElement&gt; qoeFromString = GumgaGenericRepositoryHelper.qoeFromString(query.getAqo());
//        String hqlFromQes = &quot;&quot;;// GumgaGenericRepositoryHelper.hqlFromQoes(entityInformation,qoeFromString);
//
//        if (!QueryObject.EMPTY.equals(query.getAqo())) {
//            //query.setAq(hqlFromQes);
//        }
<span class="fc" id="L241">        String modelo = &quot;from %s obj WHERE %s&quot;;</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="fc" id="L243">            GumgaMultitenancy gumgaMultiTenancy = getDomainClass().getAnnotation(GumgaMultitenancy.class);</span>
<span class="fc" id="L244">            String oiPattern = GumgaMultitenancyUtil.getMultitenancyPattern(gumgaMultiTenancy);</span>
<span class="fc" id="L245">            String sharedCriterion = &quot; &quot;;</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">            if (GumgaSharedModel.class.isAssignableFrom(entityInformation.getJavaType())) {</span>
<span class="fc" id="L247">                sharedCriterion = &quot;or (obj.gumgaOrganizations like '%%,&quot; + oiPattern + &quot;,%%' or &quot;</span>
<span class="fc" id="L248">                        + &quot;obj.gumgaUsers like '%%,&quot; + GumgaThreadScope.login.get() + &quot;,%%') &quot;;</span>
            }
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">            if (gumgaMultiTenancy.allowPublics()) {</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">                if (gumgaMultiTenancy.publicMarking() == TenancyPublicMarking.NULL) {</span>
<span class="fc" id="L252">                    modelo = &quot;from %s obj WHERE (obj.oi is null OR obj.oi like '&quot; + oiPattern + &quot;%%' &quot; + sharedCriterion + &quot;)  AND (%s) &quot;;</span>
                } else {
<span class="nc" id="L254">                    modelo = &quot;from %s obj WHERE (obj.oi = '&quot; + gumgaMultiTenancy.publicMarking().getMark() + &quot;' OR obj.oi like '&quot; + oiPattern + &quot;%%' &quot; + sharedCriterion + &quot;)  AND (%s) &quot;;</span>
                }
            } else {
<span class="nc" id="L257">                modelo = &quot;from %s obj WHERE (obj.oi like '&quot; + oiPattern + &quot;%%' &quot; + sharedCriterion + &quot;)  AND (%s) &quot;;</span>
            }
        }

        String hqlConsulta;
<span class="fc bfc" id="L262" title="All 2 branches covered.">        if (query.getSortField().isEmpty()) {</span>
<span class="fc" id="L263">            hqlConsulta = String.format(modelo + &quot; ORDER BY obj.id &quot;, entityInformation.getEntityName(), query.getAq());</span>
        } else {
<span class="fc" id="L265">            hqlConsulta = String.format(modelo + &quot; ORDER BY %s %s, obj.id&quot;, entityInformation.getEntityName(), query.getAq(), query.getSortField(), query.getSortDir());</span>
        }
<span class="fc" id="L267">        String hqlConta = String.format(&quot;SELECT count(obj) &quot; + modelo, entityInformation.getEntityName(), query.getAq());</span>
<span class="fc" id="L268">        Query qConta = entityManager.createQuery(hqlConta);</span>
<span class="fc" id="L269">        Query qConsulta = entityManager.createQuery(hqlConsulta);</span>
<span class="fc" id="L270">        Long total = (Long) qConta.getSingleResult();</span>
<span class="fc" id="L271">        qConsulta.setMaxResults(query.getPageSize());</span>
<span class="fc" id="L272">        qConsulta.setFirstResult(query.getStart());</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">        List resultList = query.isCountOnly() ? Collections.emptyList() : qConsulta.getResultList();</span>
<span class="fc" id="L274">        return new SearchResult&lt;&gt;(query, total, resultList);</span>
    }

    @Override
    public &lt;A&gt; SearchResult&lt;A&gt; advancedSearch(String selectQueryWithoutWhere, String countQuery, String ordenationId, QueryObject whereQuery) {
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (Strings.isNullOrEmpty(ordenationId)) {</span>
<span class="nc" id="L280">            throw new IllegalArgumentException(&quot;Para realizar a search deve se informar um OrdenationId para complementar a ordenação&quot;);</span>
        }

<span class="nc" id="L283">        String modelo = selectQueryWithoutWhere + &quot; WHERE %s&quot;;</span>
        String hqlConsulta;
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (whereQuery.getSortField().isEmpty()) {</span>
<span class="nc" id="L286">            hqlConsulta = String.format(modelo, whereQuery.getAq());</span>
        } else {
<span class="nc" id="L288">            hqlConsulta = String.format(modelo + &quot; ORDER BY %s %s, %s&quot;, whereQuery.getAq(), whereQuery.getSortField(), whereQuery.getSortDir(), ordenationId);</span>
        }
<span class="nc" id="L290">        String hqlConta = countQuery + &quot; WHERE &quot; + whereQuery.getAq();</span>
<span class="nc" id="L291">        Query qConta = entityManager.createQuery(hqlConta);</span>
<span class="nc" id="L292">        Query qConsulta = entityManager.createQuery(hqlConsulta);</span>
<span class="nc" id="L293">        Long total = (Long) qConta.getSingleResult();</span>
<span class="nc" id="L294">        qConsulta.setMaxResults(whereQuery.getPageSize());</span>
<span class="nc" id="L295">        qConsulta.setFirstResult(whereQuery.getStart());</span>
<span class="nc" id="L296">        List resultList = qConsulta.getResultList();</span>

<span class="nc" id="L298">        return new SearchResult&lt;&gt;(whereQuery, total, resultList);</span>
    }

    @Override
    public SearchResult&lt;T&gt; search(String hql, Map&lt;String, Object&gt; params) {
<span class="nc" id="L303">        Query query = entityManager.createQuery(hql);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">        if (params != null) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">            for (String key : params.keySet()) {</span>
<span class="nc" id="L306">                query.setParameter(key, params.get(key));</span>
<span class="nc" id="L307">            }</span>
        }
<span class="nc" id="L309">        List&lt;T&gt; result = query.getResultList();</span>
<span class="nc" id="L310">        int total = result.size();</span>
<span class="nc" id="L311">        return new SearchResult&lt;&gt;(0, total, total, result);</span>
    }

    @Override
    public SearchResult&lt;T&gt; search(String hql, Map&lt;String, Object&gt; params, int max, int first) {
<span class="nc" id="L316">        Query query = entityManager.createQuery(hql);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (params != null) {</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">            for (String key : params.keySet()) {</span>
<span class="nc" id="L319">                query.setParameter(key, params.get(key));</span>
<span class="nc" id="L320">            }</span>
        }
<span class="nc" id="L322">        query.setMaxResults(max);</span>
<span class="nc" id="L323">        query.setFirstResult(first);</span>
<span class="nc" id="L324">        List&lt;T&gt; result = query.getResultList();</span>
<span class="nc" id="L325">        int total = result.size();</span>
<span class="nc" id="L326">        return new SearchResult&lt;&gt;(0, total, total, result);</span>
    }

    @Override
    protected TypedQuery&lt;Long&gt; getCountQuery(Specification&lt;T&gt; spec) {
<span class="nc" id="L331">        return super.getCountQuery(spec);</span>
    }

    @Override
    protected TypedQuery&lt;T&gt; getQuery(Specification&lt;T&gt; spec, Sort sort) {
<span class="fc" id="L336">        return super.getQuery(spec, sort);</span>
    }

    @Override
    protected TypedQuery&lt;T&gt; getQuery(Specification&lt;T&gt; spec, Pageable pageable) {
<span class="nc" id="L341">        return super.getQuery(spec, pageable);</span>
    }

    @Override
    protected Page&lt;T&gt; readPage(TypedQuery&lt;T&gt; query, Pageable pageable, Specification&lt;T&gt; spec) {
<span class="nc" id="L346">        return super.readPage(query, pageable, spec);</span>
    }

    @Override
    public void flush() {
<span class="nc" id="L351">        super.flush();</span>
<span class="nc" id="L352">    }</span>

    /**
     * salvar entidades utilizando o Multitenancy se a entidade estiver anotada com @{@link GumgaMultitenancy}
     * @param entities
     * @param &lt;S&gt;
     * @return lista das entidades salvas
     */
    @Override
    public &lt;S extends T&gt; List&lt;S&gt; save(Iterable&lt;S&gt; entities) {
<span class="nc" id="L362">        return super.save(entities);</span>
    }

    /**
     * salvar entidade utilizando o Multitenancy se a entidade estiver com @{@link GumgaMultitenancy}
     * @param entity
     * @param &lt;S&gt;
     * @return entidade salva
     */
    @Override
    public &lt;S extends T&gt; S saveAndFlush(S entity) {
<span class="nc" id="L373">        return super.saveAndFlush(entity);</span>
    }

    /**
     * salvar entidade utilizando o Multitenancy se a entidade estiver anotada com @{@link GumgaMultitenancy}
     * @param entity
     * @param &lt;S&gt;
     * @return entidade salva
     */
    @Override
    public &lt;S extends T&gt; S save(S entity) {
<span class="fc" id="L384">        return super.save(entity);</span>
    }

    @Override
    public long count(Specification&lt;T&gt; spec) {
<span class="nc" id="L389">        return super.count(spec);</span>
    }

    /**
     * Procurar a quantiadde de registro na base dados baseado na entidade tipada na interface @{@link GumgaCrudRepository}
     * @return quantidade de registro encontrados
     */
    @Override
    public long count() {
<span class="fc" id="L398">        return super.count();</span>
    }

    /**
     * Pesquisa na base de dados baseado na entidade tipada na interface @{@link GumgaCrudRepository} com os filtro passados
     * @param spec filtro a ser utilizado na pesquisa
     * @param sort a ordem que voce deseja retornar o dados
     * @return
     */
    @Override
    public List&lt;T&gt; findAll(Specification&lt;T&gt; spec, Sort sort) {

<span class="nc bnc" id="L410" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L411">            throw new GumgaGenericRepositoryException(noMultiTenancyMessage());</span>
        }
<span class="nc" id="L413">        return super.findAll(spec, sort);</span>
    }

    /**
     * Pesquisa na base de dados baseado na entidade tipada na interface @{@link GumgaCrudRepository} com os filtro passados
     * @param spec filtro a ser utilizado na pesquisa
     * @param pageable paginação
     * @return
     */
    @Override
    public Page&lt;T&gt; findAll(Specification&lt;T&gt; spec, Pageable pageable) {
<span class="nc bnc" id="L424" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L425">            throw new GumgaGenericRepositoryException(noMultiTenancyMessage());</span>
        }
<span class="nc" id="L427">        return super.findAll(spec, pageable);</span>
    }

    /**
     * Pesquisa na base de dados baseado na entidade tipada na interface @{@link GumgaCrudRepository} com os filtro passados
     * @param spec filtro a ser utilizado na pesquisa
     * @return
     */
    @Override
    public List&lt;T&gt; findAll(Specification&lt;T&gt; spec) {
<span class="nc bnc" id="L437" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L438">            throw new GumgaGenericRepositoryException(noMultiTenancyMessage());</span>
        }
<span class="nc" id="L440">        return super.findAll(spec);</span>
    }

    /**
     * Pesquisa na base de dados baseado na entidade tipada na interface @{@link GumgaCrudRepository} com os filtro passados
     * @param spec filtro a ser utilizado na pesquisa
     * @return
     */
    @Override
    public T findOne(Specification&lt;T&gt; spec) {
<span class="nc bnc" id="L450" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L451">            throw new GumgaGenericRepositoryException(noMultiTenancyMessage());</span>
        }
<span class="nc" id="L453">        return super.findOne(spec);</span>
    }

    /**
     * Pesquisa na base de dados baseado na entidade tipada na interface @{@link GumgaCrudRepository} com os filtro passados
     * @param pageable parametros da paginação
     * @return
     */
    @Override
    public Page&lt;T&gt; findAll(Pageable pageable) {
<span class="nc bnc" id="L463" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L464">            throw new GumgaGenericRepositoryException(noMultiTenancyMessage());</span>
        }
<span class="nc" id="L466">        return super.findAll(pageable);</span>
    }

    /**
     * Pesquisa na base de dados baseado na entidade tipada na interface @{@link GumgaCrudRepository} com os filtro passados
     * @param sort ordem de retorno dos dados
     * @return
     */
    @Override
    public List&lt;T&gt; findAll(Sort sort) {
<span class="nc bnc" id="L476" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L477">            throw new GumgaGenericRepositoryException(noMultiTenancyMessage());</span>
        }
<span class="nc" id="L479">        return super.findAll(sort);</span>
    }

    @Override
    public List&lt;T&gt; findAll(Iterable&lt;ID&gt; ids) {
<span class="nc bnc" id="L484" title="All 4 branches missed.">        if (ids == null || !ids.iterator().hasNext()) {</span>
<span class="nc" id="L485">            return Collections.emptyList();</span>
        }
<span class="nc" id="L487">        List&lt;T&gt; toReturn = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">        for (ID id : ids) {</span>
<span class="nc" id="L489">            Object found = findOne(id);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">            if (found != null) {</span>
<span class="nc" id="L491">                toReturn.add((T) found);</span>
            }
<span class="nc" id="L493">        }</span>
<span class="nc" id="L494">        return toReturn;</span>
    }

    /**
     * Pesquisa na base de dados baseado na entidade tipada na interface @{@link GumgaCrudRepository} com os filtro passados
     * @return
     */
    @Override
    public List&lt;T&gt; findAll() {
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="fc" id="L504">            log.error(&quot;NOMULTITENACYIMPL -&gt; &quot; + noMultiTenancyMessage());</span>
        }
<span class="fc" id="L506">        return super.findAll();</span>
    }

    /**
     * Verificar se objecto salvo no banco ja existe.
     * @param id valor a ser pequisado na primary key da entidade
     * @return
     */
    @Override
    public boolean exists(ID id) {
<span class="nc" id="L516">        return super.exists(id);</span>
    }

    /**
     * Pesquisar a entidade tipada na interface @{@link GumgaCrudRepository} com Multitenancy caso a entidade esteja anotada com @{@link GumgaMultitenancy}
     * @param id
     * @return
     */
    @Override
    public T getOne(ID id) {
<span class="nc" id="L526">        T objectFind = super.getOne(id);</span>
<span class="nc" id="L527">        checkOwnership(objectFind);</span>
<span class="nc" id="L528">        return objectFind;</span>
    }

    @Override
    public void deleteAllInBatch() {
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L534">            log.error(&quot;NOMULTITENACYIMPL -&gt; &quot; + noMultiTenancyMessage());</span>
        }
<span class="nc" id="L536">        super.deleteAllInBatch();</span>
<span class="nc" id="L537">    }</span>

    /**
     * Remove todas as entidades tipada na interface @{@link GumgaCrudRepository} da base dados
     */
    @Override
    public void deleteAll() {
<span class="nc bnc" id="L544" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L545">            log.error(&quot;NOMULTITENACYIMPL -&gt; &quot; + noMultiTenancyMessage());</span>
        }
<span class="nc" id="L547">        super.deleteAll();</span>
<span class="nc" id="L548">    }</span>

    @Override
    public void deleteInBatch(Iterable&lt;T&gt; entities) {
<span class="nc bnc" id="L552" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L553">            log.error(&quot;NOMULTITENACYIMPL -&gt; &quot; + noMultiTenancyMessage());</span>
        }
<span class="nc" id="L555">        super.deleteInBatch(entities);</span>
<span class="nc" id="L556">    }</span>

    @Override
    public void delete(Iterable&lt;? extends T&gt; entities) {
<span class="nc bnc" id="L560" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L561">            log.error(&quot;NOMULTITENACYIMPL -&gt; &quot; + noMultiTenancyMessage());</span>
        }
<span class="nc" id="L563">        super.delete(entities);</span>
<span class="nc" id="L564">    }</span>

    /**
     * Remove a entidade tipada na interface @{@link GumgaCrudRepository} da base dados
     * @param entity entidade a ser removida
     */
    @Override
    public void delete(T entity) {
<span class="nc bnc" id="L572" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L573">            checkOwnership(entity);</span>
        }
<span class="nc" id="L575">        super.delete(entity);</span>
<span class="nc" id="L576">    }</span>

    /**
     * Remove a entidade tipada na interface @{@link GumgaCrudRepository} da base dados
     * @param id primary key da entidade a ser removida da base
     */
    @Override
    public void delete(ID id) {
<span class="nc bnc" id="L584" title="All 2 branches missed.">        if (hasMultitenancy()) {</span>
<span class="nc" id="L585">            checkOwnership(findOne(id));</span>
        }
<span class="nc" id="L587">        super.delete(id);</span>
<span class="nc" id="L588">    }</span>

    @Override
    protected Class&lt;T&gt; getDomainClass() {
<span class="fc" id="L592">        return super.getDomainClass();</span>
    }

    @Override
    public void setRepositoryMethodMetadata(CrudMethodMetadata crudMethodMetadata) {
<span class="nc" id="L597">        super.setRepositoryMethodMetadata(crudMethodMetadata);</span>
<span class="nc" id="L598">    }</span>

    @Override
    public List&lt;GumgaObjectAndRevision&gt; listOldVersions(ID id) {
<span class="nc" id="L602">        List&lt;GumgaObjectAndRevision&gt; aRetornar = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L603">        AuditReader ar = AuditReaderFactory.get(entityManager);</span>
<span class="nc" id="L604">        List&lt;Number&gt; revisoes = ar.getRevisions(entityInformation.getJavaType(), id);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">        for (Number n : revisoes) {</span>
<span class="nc" id="L606">            GumgaRevisionEntity gumgaRevisionEntity = entityManager.find(GumgaRevisionEntity.class, n.longValue());</span>
<span class="nc" id="L607">            T object = ar.find(entityInformation.getJavaType(), id, n.longValue());</span>
<span class="nc" id="L608">            aRetornar.add(new GumgaObjectAndRevision(gumgaRevisionEntity, object));</span>
<span class="nc" id="L609">        }</span>
<span class="nc" id="L610">        return aRetornar;</span>
    }

    private void checkOwnership(Object o) throws EntityNotFoundException {
<span class="pc bpc" id="L614" title="3 of 4 branches missed.">        if (GumgaThreadScope.ignoreCheckOwnership.get() != null &amp;&amp; GumgaThreadScope.ignoreCheckOwnership.get()) {</span>
<span class="nc" id="L615">            return;</span>
        }
<span class="pc bpc" id="L617" title="1 of 2 branches missed.">        if (!o.getClass().isAnnotationPresent(GumgaMultitenancy.class)) {</span>
<span class="nc" id="L618">            return;</span>
        }
<span class="pc bpc" id="L620" title="1 of 2 branches missed.">        if (GumgaThreadScope.organizationCode.get() == null) {</span>
<span class="nc" id="L621">            return;</span>
        }

<span class="fc" id="L624">        GumgaModel object = (GumgaModel) o;</span>
<span class="pc bpc" id="L625" title="1 of 2 branches missed.">        if (hasMultitenancy()</span>
<span class="pc bpc" id="L626" title="1 of 2 branches missed.">                &amp;&amp; (object.getOi() != null)</span>
<span class="pc bpc" id="L627" title="2 of 4 branches missed.">                &amp;&amp; (GumgaThreadScope.organizationCode.get() == null || !object.getOi().getValue().startsWith(getMultitenancyPattern()))) {</span>
<span class="fc" id="L628">            throw new EntityNotFoundException(&quot;cannot find object of &quot; + entityInformation.getJavaType() + &quot; with id: &quot; + object.getId() + &quot; in your organization: &quot; + GumgaThreadScope.organizationCode.get());</span>
        }
<span class="nc" id="L630">    }</span>

    private String noMultiTenancyMessage() {
<span class="fc" id="L633">        StackTraceElement[] stackTrace = Thread.currentThread().getStackTrace();</span>
        String msg;
<span class="pc bpc" id="L635" title="1 of 2 branches missed.">        if (stackTrace.length &gt;= 4) {</span>
<span class="fc" id="L636">            msg = &quot;The method '&quot; + stackTrace[2].getMethodName() + &quot;' in line &quot; + stackTrace[2].getLineNumber() + &quot; of class '&quot; + stackTrace[2].getClassName()</span>
<span class="fc" id="L637">                    + &quot;' called from method '&quot; + stackTrace[3].getMethodName() + &quot;' of class '&quot; + stackTrace[3].getClassName()</span>
                    + &quot;' has no implementation for MultiTenancy yet. Ask Gumga.&quot;;
        } else {
<span class="nc" id="L640">            msg = &quot;No implementation for MultiTenancy yet. Ask Gumga.&quot;;</span>
        }
<span class="fc" id="L642">        return msg;</span>
    }

    @Override
    public SearchResult&lt;T&gt; findAllWithTenancy() {
<span class="nc" id="L647">        QueryObject qo = new QueryObject();</span>
<span class="nc" id="L648">        qo.setPageSize(Integer.MAX_VALUE - 1);</span>
<span class="nc" id="L649">        return search(qo);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>