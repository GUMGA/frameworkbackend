<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GumgaQueryParserProvider.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gumga-domain</a> &gt; <a href="index.source.html" class="el_package">io.gumga.domain</a> &gt; <span class="el_source">GumgaQueryParserProvider.java</span></div><h1>GumgaQueryParserProvider.java</h1><pre class="source lang-java linenums">package io.gumga.domain;

import br.com.insula.opes.CpfCnpj;
import io.gumga.domain.domains.usertypes.*;
import org.hibernate.criterion.Conjunction;
import org.hibernate.criterion.MatchMode;
import org.hibernate.criterion.Restrictions;
import org.hibernate.type.StandardBasicTypes;

import java.math.BigDecimal;
import java.math.BigInteger;
import java.text.Normalizer;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import static java.util.concurrent.TimeUnit.DAYS;
import static org.hibernate.criterion.Restrictions.eq;

/**
 * Classe utilizada para especificar como cada tipo de dados será pequisado em
 * cada SGBD
 *
 * @author munif
 */
public class GumgaQueryParserProvider {

<span class="nc" id="L30">    public static Map&lt;Class&lt;?&gt;, CriterionParser&gt; defaultMap = null;</span>

<span class="nc" id="L32">    private GumgaQueryParserProvider() {</span>
<span class="nc" id="L33">    }</span>

    public static final Map&lt;Class&lt;?&gt;, CriterionParser&gt; getH2LikeMap() {
<span class="nc" id="L36">        return getBaseMap();</span>
    }

    public static final Map&lt;Class&lt;?&gt;, CriterionParser&gt; getOracleLikeMap() {
<span class="nc" id="L40">        Map&lt;Class&lt;?&gt;, CriterionParser&gt; oracleMap = getBaseMap();</span>
<span class="nc" id="L41">        oracleMap.put(String.class, AbstractStringCriterionParser.ORACLE_STRING_CRITERION_PARSER);</span>
<span class="nc" id="L42">        return oracleMap;</span>
    }

    public static final Map&lt;Class&lt;?&gt;, CriterionParser&gt; getMySqlLikeMap() {
<span class="nc" id="L46">        Map&lt;Class&lt;?&gt;, CriterionParser&gt; mySqlMap = getBaseMap();</span>
<span class="nc" id="L47">        mySqlMap.put(String.class, AbstractStringCriterionParser.MYSQL_STRING_CRITERION_PARSER);</span>
<span class="nc" id="L48">        return mySqlMap;</span>
    }

    public static final Map&lt;Class&lt;?&gt;, CriterionParser&gt; getPostgreSqlLikeMap() {
<span class="nc" id="L52">        Map&lt;Class&lt;?&gt;, CriterionParser&gt; mySqlMap = getBaseMap();</span>
<span class="nc" id="L53">        mySqlMap.put(String.class, AbstractStringCriterionParser.POSTGRESQL_STRING_CRITERION_PARSER);</span>
<span class="nc" id="L54">        return mySqlMap;</span>
    }

<span class="nc" id="L57">    protected static final CriterionParser STRING_CRITERION_PARSER_WITHOUT_TRANSLATE = (field, value) -&gt; {</span>

<span class="nc" id="L59">        value = Normalizer.normalize(value, Normalizer.Form.NFD).replaceAll(&quot;[^\\p{ASCII}]&quot;, &quot;&quot;);</span>

<span class="nc" id="L61">        String[] chain = field.split(&quot;\\.&quot;);</span>

<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (chain.length &gt; 1) {</span>
<span class="nc" id="L64">            return Restrictions.like(field, value, MatchMode.ANYWHERE).ignoreCase();</span>
        }
<span class="nc" id="L66">        String caseInsensitive = &quot;upper({alias}.&quot; + field + &quot;) like (?)&quot;;</span>

<span class="nc" id="L68">        return Restrictions.sqlRestriction(caseInsensitive, &quot;%&quot; + value + &quot;%&quot;, StandardBasicTypes.STRING);</span>
    };

    /**
     * Use &lt;code&gt;gumga.framework.domain.AbstractStringCriterionParser&lt;/code&gt;
     * instead
     *
     * @deprecated
     */
    @Deprecated
<span class="nc" id="L78">    private static final CriterionParser STRING_CRITERION_PARSER = (field, value) -&gt; {</span>

<span class="nc" id="L80">        value = Normalizer.normalize(value, Normalizer.Form.NFD).replaceAll(&quot;[^\\p{ASCII}]&quot;, &quot;&quot;);</span>

<span class="nc" id="L82">        String[] chain = field.split(&quot;\\.&quot;);</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (chain.length &gt; 1) {</span>
<span class="nc" id="L85">            return Restrictions.like(field, value, MatchMode.ANYWHERE).ignoreCase();</span>
        }
<span class="nc" id="L87">        String ignoraAcentos = &quot;upper({alias}.&quot; + field + &quot;) like (?)&quot;;</span>

<span class="nc" id="L89">        ignoraAcentos = &quot;upper(translate({alias}.&quot; + field + &quot;,'&quot; + AbstractStringCriterionParser.SOURCE_CHARS + &quot;','&quot; + AbstractStringCriterionParser.TARGET_CHARS + &quot;')) like (?)&quot;; //NAO FUNCIONA NO MYSQL</span>

<span class="nc" id="L91">        return Restrictions.sqlRestriction(ignoraAcentos, &quot;%&quot; + value + &quot;%&quot;, StandardBasicTypes.STRING);</span>
    };

<span class="nc" id="L94">    private static final CriterionParser CHARACTER_CRITERION_PARSER = (field, value) -&gt; {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (value.length() == 1) {</span>
<span class="nc" id="L96">            return eq(field, new Character(value.charAt(0)));</span>
        }

<span class="nc" id="L99">        throw new IllegalArgumentException(value);</span>
    };

<span class="nc" id="L102">    private static final CriterionParser BOOLEAN_CRITERION_PARSER = (field, value) -&gt; {</span>
<span class="nc" id="L103">        value = value.toLowerCase();</span>

<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (value.equals(&quot;sim&quot;)) {</span>
<span class="nc" id="L106">            value = &quot;true&quot;;</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">        } else if (value.equals(&quot;não&quot;) || value.equals(&quot;nao&quot;)) {</span>
<span class="nc" id="L108">            value = &quot;false&quot;;</span>
        }

<span class="nc bnc" id="L111" title="All 4 branches missed.">        if (value.equals(&quot;true&quot;) || value.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L112">            return eq(field, new Boolean(value));</span>
        }

<span class="nc" id="L115">        throw new IllegalArgumentException(value);</span>
    };

<span class="nc" id="L118">    private static final CriterionParser SHORT_CRITERION_PARSER = (field, value) -&gt; eq(field, new Short(value));</span>

<span class="nc" id="L120">    private static final CriterionParser INTEGER_CRITERION_PARSER = (field, value) -&gt; eq(field, new Integer(value));</span>

<span class="nc" id="L122">    private static final CriterionParser LONG_CRITERION_PARSER = (field, value) -&gt; eq(field, new Long(value));</span>

<span class="nc" id="L124">    private static final CriterionParser FLOAT_CRITERION_PARSER = (field, value) -&gt; eq(field, new Float(value));</span>

<span class="nc" id="L126">    private static final CriterionParser DOUBLE_CRITERION_PARSER = (field, value) -&gt; eq(field, new Double(value));</span>

<span class="nc" id="L128">    private static final CriterionParser BIGINTEGER_CRITERION_PARSER = (field, value) -&gt; eq(field, new BigInteger(value));</span>

<span class="nc" id="L130">    private static final CriterionParser BIGDECIMAL_CRITERION_PARSER = (field, value) -&gt; eq(field, new BigDecimal(value));</span>

<span class="nc" id="L132">    private static final CriterionParser DATE_CRITERION_PARSER = (field, value) -&gt; {</span>
        try {
<span class="nc" id="L134">            SimpleDateFormat formatter = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;);</span>

<span class="nc" id="L136">            Date minDate = formatter.parse(value);</span>
<span class="nc" id="L137">            Date maxDate = new Date(minDate.getTime() + DAYS.toMillis(1));</span>

<span class="nc" id="L139">            Conjunction and = Restrictions.conjunction();</span>
<span class="nc" id="L140">            and.add(Restrictions.ge(field, minDate));</span>
<span class="nc" id="L141">            and.add(Restrictions.lt(field, maxDate));</span>

<span class="nc" id="L143">            return and;</span>
<span class="nc" id="L144">        } catch (ParseException e) {</span>
<span class="nc" id="L145">            throw new IllegalArgumentException(value);</span>
        }
    };

    private static final Map&lt;Class&lt;?&gt;, CriterionParser&gt; getBaseMap() {
<span class="nc" id="L150">        Map&lt;Class&lt;?&gt;, CriterionParser&gt; parsers = new HashMap&lt;&gt;();</span>
<span class="nc" id="L151">        parsers.put(String.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L152">        parsers.put(Character.class, CHARACTER_CRITERION_PARSER);</span>
<span class="nc" id="L153">        parsers.put(char.class, CHARACTER_CRITERION_PARSER);</span>
<span class="nc" id="L154">        parsers.put(Boolean.class, BOOLEAN_CRITERION_PARSER);</span>
<span class="nc" id="L155">        parsers.put(boolean.class, BOOLEAN_CRITERION_PARSER);</span>
<span class="nc" id="L156">        parsers.put(Short.class, SHORT_CRITERION_PARSER);</span>
<span class="nc" id="L157">        parsers.put(short.class, SHORT_CRITERION_PARSER);</span>
<span class="nc" id="L158">        parsers.put(Integer.class, INTEGER_CRITERION_PARSER);</span>
<span class="nc" id="L159">        parsers.put(int.class, INTEGER_CRITERION_PARSER);</span>
<span class="nc" id="L160">        parsers.put(Long.class, LONG_CRITERION_PARSER);</span>
<span class="nc" id="L161">        parsers.put(long.class, LONG_CRITERION_PARSER);</span>
<span class="nc" id="L162">        parsers.put(Float.class, FLOAT_CRITERION_PARSER);</span>
<span class="nc" id="L163">        parsers.put(float.class, FLOAT_CRITERION_PARSER);</span>
<span class="nc" id="L164">        parsers.put(Double.class, DOUBLE_CRITERION_PARSER);</span>
<span class="nc" id="L165">        parsers.put(double.class, DOUBLE_CRITERION_PARSER);</span>
<span class="nc" id="L166">        parsers.put(BigInteger.class, BIGINTEGER_CRITERION_PARSER);</span>
<span class="nc" id="L167">        parsers.put(BigDecimal.class, BIGDECIMAL_CRITERION_PARSER);</span>
<span class="nc" id="L168">        parsers.put(Date.class, DATE_CRITERION_PARSER);</span>
<span class="nc" id="L169">        parsers.put(CpfCnpj.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE); //Domínio da Insula utilizado na DB1</span>
<span class="nc" id="L170">        parsers.put(GumgaAddressUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L171">        parsers.put(GumgaBooleanUserType.class, BOOLEAN_CRITERION_PARSER);</span>
<span class="nc" id="L172">        parsers.put(GumgaBarCodeUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L173">        parsers.put(GumgaCEPUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L174">        parsers.put(GumgaCNPJUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L175">        parsers.put(GumgaCPFUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L176">        parsers.put(GumgaEMailUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L177">        parsers.put(GumgaGeoLocationUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L178">        parsers.put(GumgaIP4UserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L179">        parsers.put(GumgaIP6UserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L180">        parsers.put(GumgaMoneyUserType.class, BIGDECIMAL_CRITERION_PARSER);</span>
<span class="nc" id="L181">        parsers.put(GumgaMultiLineStringUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L182">        parsers.put(GumgaPhoneNumberUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L183">        parsers.put(GumgaTimeUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L184">        parsers.put(GumgaOiUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
<span class="nc" id="L185">        parsers.put(GumgaURLUserType.class, STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>

<span class="nc" id="L187">        return parsers;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>