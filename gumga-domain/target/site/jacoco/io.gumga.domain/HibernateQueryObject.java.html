<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HibernateQueryObject.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gumga-domain</a> &gt; <a href="index.source.html" class="el_package">io.gumga.domain</a> &gt; <span class="el_source">HibernateQueryObject.java</span></div><h1>HibernateQueryObject.java</h1><pre class="source lang-java linenums">package io.gumga.domain;

import io.gumga.core.QueryObject;
import io.gumga.core.utils.ReflectionUtils;
import org.hibernate.criterion.Criterion;
import org.hibernate.criterion.Restrictions;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.activation.UnsupportedDataTypeException;
import java.text.Normalizer;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Permite utilizar um QueryObject do framework em com o Hibernate.
 */

public class HibernateQueryObject {

<span class="nc" id="L24">    private final Logger logger = LoggerFactory.getLogger(getClass());</span>

    protected final QueryObject queryObject;

    protected final Map&lt;Class&lt;?&gt;, CriterionParser&gt; parsers;

<span class="nc" id="L30">    public HibernateQueryObject(QueryObject queryObject) {</span>

<span class="nc" id="L32">        this.queryObject = queryObject;</span>

<span class="nc" id="L34">        this.parsers = new HashMap&lt;&gt;(GumgaQueryParserProvider.defaultMap);</span>

<span class="nc bnc" id="L36" title="All 2 branches missed.">        if (null == GumgaQueryParserProvider.defaultMap) {</span>
<span class="nc" id="L37">            throw new HibernateQueryObjectException(&quot;GumgaQueryParserProvider.defaultMap must be set in Application configuration&quot;);</span>
        }
        

<span class="nc bnc" id="L41" title="All 2 branches missed.">        if (!queryObject.isPhonetic()) {</span>
<span class="nc" id="L42">            this.parsers.put(String.class, GumgaQueryParserProvider.STRING_CRITERION_PARSER_WITHOUT_TRANSLATE);</span>
        }

<span class="nc" id="L45">        this.queryObject.setQ(Normalizer.normalize(queryObject.getQ(), Normalizer.Form.NFD).replaceAll(&quot;[^\\p{ASCII}]&quot;, &quot;&quot;).toUpperCase());</span>
<span class="nc" id="L46">    }</span>

    public Criterion[] getCriterions(Class&lt;?&gt; clazz) {
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (!queryObject.isValid()) {</span>
<span class="nc" id="L50">            return new Criterion[0];</span>
        }

<span class="nc" id="L53">        List&lt;Criterion&gt; criterions = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L55" title="All 2 branches missed.">        for (String field : queryObject.getSearchFields()) {</span>
            try {
<span class="nc" id="L57">                criterions.add(createCriterion(field, queryObject.getQ(), clazz));</span>
<span class="nc" id="L58">            } catch (ParseException ex) {</span>
<span class="nc" id="L59">                throw new HibernateQueryObjectException(&quot;Problem creating creterion.Cannot parse field &quot; + field);</span>
<span class="nc" id="L60">            } catch (NumberFormatException ex) {</span>
<span class="nc" id="L61">                throw new HibernateQueryObjectException(&quot;Problem creating creterion.Number format problem in field  &quot; + field);</span>
<span class="nc" id="L62">            } catch (UnsupportedDataTypeException ex) {</span>
<span class="nc" id="L63">                throw new HibernateQueryObjectException(&quot;Problem creating creterion.Unsupported data type in field &quot; + field);</span>
<span class="nc" id="L64">            }</span>
        }

<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (criterions.isEmpty()) {</span>
<span class="nc" id="L68">            forceNoResults(criterions);</span>
        }

<span class="nc" id="L71">        return criterions.toArray(new Criterion[criterions.size()]);</span>
    }

    private Criterion createCriterion(String field, String value, Class&lt;?&gt; clazz) throws ParseException, NumberFormatException, UnsupportedDataTypeException {
<span class="nc" id="L75">        String[] chain = field.split(&quot;\\.&quot;);</span>
        Class&lt;?&gt; type;

<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (chain.length &gt; 1) {</span>
<span class="nc" id="L79">            Class&lt;?&gt; superType = ReflectionUtils.findField(clazz, chain[0]).getType();</span>
<span class="nc" id="L80">            type = ReflectionUtils.findField(superType, chain[1]).getType();</span>
<span class="nc" id="L81">        } else {</span>
<span class="nc" id="L82">            type = ReflectionUtils.findField(clazz, field).getType();</span>
        }

<span class="nc" id="L85">        CriterionParser parser = parsers.get(type);</span>

<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (parser == null) {</span>
<span class="nc" id="L88">            throw new UnsupportedDataTypeException(type.getName());</span>
        }

<span class="nc" id="L91">        return parser.parse(field, value);</span>
    }

    protected void forceNoResults(List&lt;Criterion&gt; criterions) {
<span class="nc" id="L95">        criterions.add(Restrictions.sqlRestriction(&quot;(1=0)&quot;));</span>
<span class="nc" id="L96">    }</span>

}


class HibernateQueryObjectException extends RuntimeException{

    public HibernateQueryObjectException(String message) {
<span class="nc" id="L104">        super(message);</span>
<span class="nc" id="L105">    }</span>
    
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>